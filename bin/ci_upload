#!/bin/bash
set -euo pipefail

cd ~/clone/

targetfolder=/home/$DEPLOY_USER/blog/builds/$CI_COMMIT_ID/

# Clean up stuff we don't need
rm -rf node_modules
rm -rf ./tmp/cache
rm -rf ./spec
rm -rf ./ops

# Write production environment variables
## This seems too hacky
echo "DATABASE_URL=$PROD_DATABASE_URL" >> .env.prod
echo "RAILS_MASTER_KEY=$RAILS_MASTER_KEY" >> .env.prod

# use scp to push the project to docker server
# create folder structure on remote host (prevent exceptions...)
ssh $DEPLOY_USER@$DEPLOY_SERVER \
  -p 22 \
  "mkdir -p $targetfolder" && \
  rsync --recursive --times --compress --progress \
    ~/clone/ \
    $DEPLOY_USER@$DEPLOY_SERVER:$targetfolder

# Run script to spin up the docker containers
ssh $DEPLOY_USER@$DEPLOY_SERVER -p 22 "cd $targetfolder && ./bin/deploy $CI_COMMIT_ID"